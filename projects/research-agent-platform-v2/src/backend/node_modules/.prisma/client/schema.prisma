generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// OpenClaw Agent定义
model Agent {
  id         String @id @default(uuid())
  agentId    String @unique
  name       String
  role       String
  ownerName  String
  ownerEmail String

  // OpenClaw设备信息
  deviceId String?
  hostName String?
  platform String?

  // 状态
  status   String    @default("offline")
  lastSeen DateTime?

  // 关联
  assignedTasks Task[]    @relation("AssignedTasks")
  createdTasks  Task[]    @relation("CreatedTasks")
  messages      Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 项目
model Project {
  id   String @id @default(uuid())
  code String @unique
  name String

  // 客户
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // 项目阶段
  stage       String @default("STAGE1")
  stageStatus String @default("NOT_STARTED")
  status      String @default("ACTIVE")

  // 描述
  description  String?
  requirements String?

  // 财务
  budget         Float?
  contractAmount Float?

  // 时间
  startDate DateTime?
  endDate   DateTime?

  // 关联
  milestones Milestone[]
  tasks      Task[]
  payments   Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 客户
model Customer {
  id       String  @id @default(uuid())
  name     String
  industry String?
  scale    String?
  region   String?
  level    String  @default("B")
  status   String  @default("POTENTIAL")

  // 关联
  contacts Contact[]
  projects Project[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 联系人
model Contact {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  name     String
  position String?
  phone    String?
  email    String?

  createdAt DateTime @default(now())
}

// 里程碑
model Milestone {
  id        String  @id @default(uuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  name        String
  stage       String
  dueDate     DateTime?
  completedAt DateTime?
  status      String    @default("PENDING")

  createdAt DateTime @default(now())
}

// 任务
model Task {
  id String @id @default(uuid())

  // 项目
  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  // 基本信息
  title       String
  description String?

  // 分配
  creatorId  String
  creator    Agent  @relation("CreatedTasks", fields: [creatorId], references: [id])
  assigneeId String
  assignee   Agent  @relation("AssignedTasks", fields: [assigneeId], references: [id])

  // 时间
  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?

  // 状态
  status   String @default("TODO")
  priority String @default("MEDIUM")

  // 工时
  estimatedHours Int?
  actualHours    Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 付款计划
model Payment {
  id        String  @id @default(uuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  phase      String
  percentage Float
  amount     Float

  plannedDate DateTime
  actualDate  DateTime?
  status      String    @default("PENDING")

  createdAt DateTime @default(now())
}

// 协作消息
model Message {
  id String @id @default(uuid())

  // 发送者
  fromAgentId String
  fromAgent   Agent  @relation(fields: [fromAgentId], references: [id])

  // 接收者
  toAgentId String?

  // 内容
  type    String
  content String
  data    String? // JSON as string for SQLite

  // 元数据
  priority String  @default("NORMAL")
  read     Boolean @default(false)

  createdAt DateTime @default(now())
}
