import { useState, useCallback, useEffect, useRef } from 'react'
import { Canvas } from '@react-three/fiber'
import { OrbitControls, Stars, PerspectiveCamera } from '@react-three/drei'
import { ChineseCourtyard } from './components/Courtyard'
import { RealisticAgent } from './components/RealisticAgent'
import { Dashboards } from './components/Dashboards'
import { OfficeDecorations } from './components/OfficeDecorations'
import { AgentChatSystem } from './components/ChatBubble'
import { InteractionFeedback } from './components/InteractionFeedback'
import { EnvironmentController, WeatherType } from './components/EnvironmentController'
import { metaverseDataService, AgentState } from './services/metaverseData'
import { AGENTS_DATA, AgentRole, STATUS_CONFIG } from './data/agents'
import { FirstPersonController } from './components/FirstPersonController'
import { MeetingRoom3D } from './components/MeetingRoom3D'
import { CollaborationLines, CollaborationHub } from './components/CollaborationLines'
import { ConnectionIndicator } from './components/ConnectionStatus'
import { AgentSidebar } from './components/AgentSidebar'
import { DepartmentRooms, DEPARTMENT_INFO } from './components/DepartmentRooms'
import { DepartmentTaskBoards } from './components/DepartmentTaskBoard'
import './App.css'

// AIè§’è‰²ä½ç½®é…ç½®ï¼ˆåŸºäºä¸šåŠ¡é˜¶æ®µï¼‰- 7ä¸ªAgentï¼ˆè¿ç»´å·²åˆå¹¶åˆ°äº¤ä»˜ï¼‰
const AGENT_POSITIONS: Record<AgentRole, [number, number, number]> = {
  market: [-15, 0, 10],      // é˜¶æ®µ1: å¸‚åœºå¯¹æ¥
  solution: [-5, 0, 5],      // é˜¶æ®µ2: æ–¹æ¡ˆåˆ¶å®š
  project: [0, 0, 0],        // ä¸­å¿ƒ: é¡¹ç›®ç®¡å®¶
  developer: [5, 0, 0],      // é˜¶æ®µ3: ç ”å‘Demo
  delivery: [15, 0, -5],     // é˜¶æ®µ4: å®æ–½äº¤ä»˜ï¼ˆå«è¿ç»´ï¼‰
  finance: [5, 0, -5],       // è´¦æˆ¿
  director: [0, 5, -15],     // æ­£å ‚é«˜ä½
}

// è§’è‰²è¯¦æƒ…å¼¹çª—
function AgentModal({ 
  role, 
  onClose,
  onlineAgents
}: { 
  role: AgentRole
  onClose: () => void
  onlineAgents: string[]
}) {
  const agent = AGENTS_DATA[role]
  const status = STATUS_CONFIG[agent.status]
  const isOnline = onlineAgents.includes(role)
  
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()}>
        <button className="modal-close" onClick={onClose}>Ã—</button>
        
        {/* å¤´éƒ¨ */}
        <div className="modal-header" style={{ backgroundColor: agent.color }}>
          <div className="modal-icon">{agent.emoji}</div>
          <div className="modal-title">
            <h2>{agent.name}</h2>
            <p>{agent.title} | {agent.department}</p>
            <span className="status-badge" style={{ backgroundColor: status.bgColor, color: status.color }}>
              {isOnline ? 'ğŸŸ¢' : 'âšª'} {status.label}
            </span>
          </div>
        </div>
        
        {/* å†…å®¹ */}
        <div className="modal-body">
          {/* OpenClawè®¾å¤‡ä¿¡æ¯ */}
          <div className="modal-section device-info">
            <h3>ğŸ”Œ OpenClawè®¾å¤‡</h3>
            <p><strong>æ‰€å±çœŸäºº:</strong> {agent.ownerName}</p>
            <p><strong>è”ç³»é‚®ç®±:</strong> {agent.ownerEmail}</p>
            <p><strong>è®¾å¤‡çŠ¶æ€:</strong> {isOnline ? 'ğŸŸ¢ åœ¨çº¿' : 'âšª ç¦»çº¿'}</p>
          </div>
          
          {/* ç®€ä»‹ */}
          <div className="modal-section">
            <h3>ğŸ“‹ è§’è‰²ç®€ä»‹</h3>
            <p>{agent.description}</p>
          </div>
          
          {/* å½“å‰ä»»åŠ¡ */}
          <div className="modal-section highlight">
            <h3>ğŸ¯ å½“å‰ä»»åŠ¡</h3>
            <p className="current-task">{agent.currentTask}</p>
          </div>
          
          {/* èƒ½åŠ›æ¸…å• */}
          <div className="modal-section">
            <h3>ğŸ’ª èƒ½åŠ›æ¸…å•</h3>
            <ul>
              {agent.capabilities.map((item: string, i: number) => (
                <li key={i}>{item}</li>
              ))}
            </ul>
          </div>
          
          {/* æŠ€èƒ½ */}
          <div className="modal-section">
            <h3>ğŸ’¡ æ ¸å¿ƒæŠ€èƒ½</h3>
            <div className="skills-grid">
              {agent.skills.map((skill, i) => (
                <span key={i} className="skill-tag">{skill}</span>
              ))}
            </div>
          </div>
          
          {/* ç»Ÿè®¡ */}
          <div className="modal-section stats">
            <h3>ğŸ“Š å·¥ä½œç»Ÿè®¡</h3>
            <div className="stats-grid">
              <div className="stat-item">
                <span className="stat-value">{agent.stats.tasksCompleted}</span>
                <span className="stat-label">å·²å®Œæˆä»»åŠ¡</span>
              </div>
              <div className="stat-item">
                <span className="stat-value">{agent.stats.tasksPending}</span>
                <span className="stat-label">å¾…å¤„ç†ä»»åŠ¡</span>
              </div>
              <div className="stat-item">
                <span className="stat-value">{agent.stats.collaborationScore}</span>
                <span className="stat-label">åä½œè¯„åˆ†</span>
              </div>
              <div className="stat-item">
                <span className="stat-value">{agent.stats.responseTime}min</span>
                <span className="stat-label">å¹³å‡å“åº”</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

// é¡¶éƒ¨ä¿¡æ¯é¢æ¿
function InfoPanel() {
  return (
    <div className="info-panel" style={{ left: '300px' }}>
      <div className="info-title">
        <span className="info-icon">ğŸ›ï¸</span>
        <div>
          <h1>ç ”ç©¶é™¢AI Agentåä½œå¹³å°</h1>
          <p>8ä¸ªOpenClawæ•°å­—å‘˜å·¥è‡ªä¸»åä½œ</p>
        </div>
      </div>
      
      <div className="stage-legend">
        <div className="stage-item">
          <span className="stage-dot" style={{ background: '#3B82F6' }}></span>
          <span>é˜¶æ®µ1: å¸‚åœºå¯¹æ¥</span>
        </div>
        <div className="stage-item">
          <span className="stage-dot" style={{ background: '#F59E0B' }}></span>
          <span>é˜¶æ®µ2: æ–¹æ¡ˆåˆ¶å®š</span>
        </div>
        <div className="stage-item">
          <span className="stage-dot" style={{ background: '#EF4444' }}></span>
          <span>é˜¶æ®µ3: ç ”å‘Demo</span>
        </div>
        <div className="stage-item">
          <span className="stage-dot" style={{ background: '#10B981' }}></span>
          <span>é˜¶æ®µ4: å®æ–½äº¤ä»˜</span>
        </div>
      </div>
    </div>
  )
}

// ä¼šè®®å®¤åˆ—è¡¨
const MEETING_ROOMS = [
  {
    id: 'project-sync',
    name: 'é¡¹ç›®åŒæ­¥ä¼š',
    topic: 'æ™ºæ…§æ ¡å›­é¡¹ç›®è¿›åº¦åŒæ­¥',
    participants: ['director', 'project', 'solution', 'developer'] as AgentRole[]
  },
  {
    id: 'tech-review',
    name: 'æŠ€æœ¯è¯„å®¡ä¼š',
    topic: 'ç³»ç»Ÿæ¶æ„æŠ€æœ¯è¯„å®¡',
    participants: ['solution', 'developer', 'devops', 'project'] as AgentRole[]
  },
  {
    id: 'client-demo',
    name: 'å®¢æˆ·æ¼”ç¤ºä¼š',
    topic: 'äº§å“åŠŸèƒ½æ¼”ç¤ºä¸ç­”ç–‘',
    participants: ['market', 'solution', 'developer', 'director'] as AgentRole[]
  },
  {
    id: 'finance-review',
    name: 'è´¢åŠ¡å¤ç›˜ä¼š',
    topic: 'é¡¹ç›®æˆæœ¬ä¸é¢„ç®—åˆ†æ',
    participants: ['finance', 'project', 'director', 'delivery'] as AgentRole[]
  }
]

// å³ä¾§æ“ä½œèœå•é¢æ¿
function RightSideMenu({
  onViewModeChange,
  onEnterMeetingRoom,
  viewMode,
  currentMeetingRoom
}: {
  onViewModeChange: (mode: 'orbit' | 'first-person') => void
  onEnterMeetingRoom: (roomId: string | null) => void
  viewMode: 'orbit' | 'first-person'
  currentMeetingRoom: string | null
}) {
  return (
    <div style={{
      position: 'absolute',
      right: '20px',
      top: '50%',
      transform: 'translateY(-50%)',
      background: 'rgba(255, 255, 255, 0.95)',
      borderRadius: '16px',
      padding: '20px',
      boxShadow: '0 8px 32px rgba(0, 0, 0, 0.2)',
      display: 'flex',
      flexDirection: 'column',
      gap: '12px',
      zIndex: 1000,
      minWidth: '180px',
      maxHeight: '80vh',
      overflowY: 'auto'
    }}>
      <h4 style={{
        margin: '0 0 8px 0',
        fontSize: '16px',
        color: '#333',
        borderBottom: '2px solid #e0e0e0',
        paddingBottom: '10px',
        textAlign: 'center'
      }}>
        ğŸ® åŠŸèƒ½èœå•
      </h4>
      
      <button
        onClick={() => onViewModeChange('orbit')}
        style={{
          padding: '12px 16px',
          borderRadius: '10px',
          border: 'none',
          background: viewMode === 'orbit' ? '#4A90E2' : '#f0f0f0',
          color: viewMode === 'orbit' ? 'white' : '#333',
          cursor: 'pointer',
          fontSize: '14px',
          fontWeight: 'bold',
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
          transition: 'all 0.2s'
        }}
      >
        ğŸ¥ ç¯ç»•è§†è§’
      </button>
      
      <button
        onClick={() => onViewModeChange('first-person')}
        style={{
          padding: '12px 16px',
          borderRadius: '10px',
          border: 'none',
          background: viewMode === 'first-person' ? '#4A90E2' : '#f0f0f0',
          color: viewMode === 'first-person' ? 'white' : '#333',
          cursor: 'pointer',
          fontSize: '14px',
          fontWeight: 'bold',
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
          transition: 'all 0.2s'
        }}
      >
        ğŸš¶ æ¼«æ¸¸æ¨¡å¼
      </button>
      
      <div style={{ height: '1px', background: '#e0e0e0', margin: '8px 0' }} />
      
      <h4 style={{
        margin: '0',
        fontSize: '14px',
        color: '#333',
        textAlign: 'center'
      }}>
        ğŸ¢ ä¼šè®®å®¤åˆ—è¡¨
      </h4>
      
      {MEETING_ROOMS.map(room => (
        <button
          key={room.id}
          onClick={() => onEnterMeetingRoom(currentMeetingRoom === room.id ? null : room.id)}
          style={{
            padding: '10px 12px',
            borderRadius: '8px',
            border: '2px solid ' + (currentMeetingRoom === room.id ? '#4A90E2' : '#e0e0e0'),
            background: currentMeetingRoom === room.id ? '#4A90E2' : 'white',
            color: currentMeetingRoom === room.id ? 'white' : '#333',
            cursor: 'pointer',
            fontSize: '13px',
            fontWeight: currentMeetingRoom === room.id ? 'bold' : 'normal',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'flex-start',
            gap: '4px',
            transition: 'all 0.2s',
            textAlign: 'left'
          }}
        >
          <span>{currentMeetingRoom === room.id ? 'ğŸ”´ ' : 'âšª '}{room.name}</span>
          <span style={{
            fontSize: '11px',
            opacity: 0.8,
            fontWeight: 'normal'
          }}>
            {room.topic}
          </span>
        </button>
      ))}
      
      {currentMeetingRoom && (
        <button
          onClick={() => onEnterMeetingRoom(null)}
          style={{
            padding: '10px 16px',
            borderRadius: '8px',
            border: 'none',
            background: '#EF4444',
            color: 'white',
            cursor: 'pointer',
            fontSize: '13px',
            fontWeight: 'bold',
            marginTop: '8px'
          }}
        >
          âŒ é€€å‡ºä¼šè®®å®¤
        </button>
      )}
      
      <div style={{
        marginTop: '8px',
        padding: '10px',
        background: '#f8f9fa',
        borderRadius: '8px',
        fontSize: '11px',
        color: '#666',
        lineHeight: '1.5'
      }}>
        <div style={{ fontWeight: 'bold', marginBottom: '4px', color: '#333' }}>ğŸ’¡ æ“ä½œæç¤ºï¼š</div>
        <div>â€¢ ç‚¹å‡»ä¼šè®®å®¤è¿›å…¥</div>
        <div>â€¢ æ¼«æ¸¸ï¼šWASDç§»åŠ¨</div>
        <div>â€¢ é¼ æ ‡æ§åˆ¶è§†è§’</div>
      </div>
    </div>
  )
}

// åº•éƒ¨æ§åˆ¶é¢æ¿
function ControlPanel({ 
  selectedRole, 
  onWeatherChange
}: {
  selectedRole: AgentRole | null
  onWeatherChange: (weather: WeatherType) => void
}) {
  return (
    <div className="control-panel" style={{ left: '300px' }}>
      <div className="control-buttons">
        <button className="control-btn" onClick={() => onWeatherChange('day')}>
          â˜€ï¸ ç™½å¤©
        </button>
        <button className="control-btn" onClick={() => onWeatherChange('night')}>
          ğŸŒ™ å¤œæ™š
        </button>
      </div>
      
      {selectedRole && (
        <div className="selected-info">
          å·²é€‰æ‹©: <strong>{AGENTS_DATA[selectedRole].name}</strong>
        </div>
      )}
    </div>
  )
}

// éƒ¨é—¨ä¿¡æ¯å¼¹çª—
function DepartmentModal({ 
  deptKey, 
  onClose 
}: { 
  deptKey: string
  onClose: () => void
}) {
  const info = DEPARTMENT_INFO[deptKey]
  if (!info) return null
  
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()}>
        <button className="modal-close" onClick={onClose}>Ã—</button>
        
        <div className="modal-header" style={{ background: '#4A90E2' }}>
          <h2>{info.name}</h2>
          <p>{info.stage}</p>
        </div>
        
        <div className="modal-body">
          <div className="modal-section">
            <h3>ğŸ“‹ éƒ¨é—¨èŒè´£</h3>
            <p>{info.description}</p>
          </div>
          
          <div className="modal-section">
            <h3>ğŸ“Œ ä¸»è¦å·¥ä½œ</h3>
            <ul>
              {info.responsibilities.map((item, i) => (
                <li key={i}>{item}</li>
              ))}
            </ul>
          </div>
          
          <div className="modal-section stats">
            <h3>ğŸ“Š å…³é”®æŒ‡æ ‡</h3>
            <div className="stats-grid">
              {info.keyMetrics.map((metric, i) => (
                <div key={i} className="stat-item">
                  <span className="stat-value">{metric.value}</span>
                  <span className="stat-label">{metric.label}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

function App() {
  const [selectedRole, setSelectedRole] = useState<AgentRole | null>(null)
  const [selectedDept, setSelectedDept] = useState<string | null>(null)
  const [weather, setWeather] = useState<WeatherType>('day')
  const [viewMode, setViewMode] = useState<'orbit' | 'first-person'>('orbit')
  const [currentMeetingRoom, setCurrentMeetingRoom] = useState<string | null>(null)
  const [onlineAgents, setOnlineAgents] = useState<string[]>(['market', 'solution', 'project', 'developer'])
  const [agentStates, setAgentStates] = useState<Record<AgentRole, AgentState>>(() => {
    const initial: Record<string, AgentState> = {}
    Object.keys(AGENTS_DATA).forEach(role => {
      initial[role] = {
        status: AGENTS_DATA[role as AgentRole].status,
        currentTask: AGENTS_DATA[role as AgentRole].currentTask,
        lastActive: new Date().toISOString()
      }
    })
    return initial as Record<AgentRole, AgentState>
  })

  // ç›‘å¬è§’è‰²ç‚¹å‡»
  const handleAgentClick = useCallback((role: AgentRole) => {
    setSelectedRole(role)
    metaverseDataService.triggerInteraction(role, 'click')
  }, [])

  // å…³é—­å¼¹çª—
  const handleCloseModal = useCallback(() => {
    setSelectedRole(null)
  }, [])

  // åˆ‡æ¢å¤©æ°”
  const handleWeatherChange = useCallback((newWeather: WeatherType) => {
    setWeather(newWeather)
  }, [])

  // åˆ‡æ¢è§†è§’æ¨¡å¼
  const handleViewModeChange = useCallback((mode: 'orbit' | 'first-person') => {
    setViewMode(mode)
  }, [])

  // è¿›å…¥/é€€å‡ºä¼šè®®å®¤
  const handleEnterMeetingRoom = useCallback((roomId: string | null) => {
    setCurrentMeetingRoom(roomId)
  }, [])

  // ç‚¹å‡»éƒ¨é—¨
  const handleDepartmentClick = useCallback((deptKey: string) => {
    setSelectedDept(deptKey)
  }, [])

  // å…³é—­éƒ¨é—¨å¼¹çª—
  const handleCloseDeptModal = useCallback(() => {
    setSelectedDept(null)
  }, [])

  return (
    <div className="app">
      {/* å·¦ä¾§Agentåˆ—è¡¨ */}
      <AgentSidebar 
        selectedRole={selectedRole}
        onSelectRole={handleAgentClick}
        onlineAgents={onlineAgents}
      />

      {/* 3Dåœºæ™¯ */}
      {currentMeetingRoom ? (
        // ä¼šè®®å®¤ç‹¬ç«‹åœºæ™¯
        <MeetingRoom3D 
          roomId={currentMeetingRoom}
          onClose={() => setCurrentMeetingRoom(null)}
        />
      ) : (
        // å››åˆé™¢åœºæ™¯
        <Canvas
          camera={{ position: [0, 15, 30], fov: 60 }}
          style={{ width: '100vw', height: '100vh' }}
        >
          <EnvironmentController weather={weather} />
          
          {viewMode === 'orbit' ? (
            <OrbitControls 
              enablePan={true} 
              enableZoom={true} 
              enableRotate={true}
              maxPolarAngle={Math.PI / 2 - 0.1}
              minDistance={10}
              maxDistance={60}
            />
          ) : (
            <FirstPersonController 
              enabled={true}
              onEnterMeetingRoom={() => handleEnterMeetingRoom('project-sync')}
            />
          )}
          
          {/* æ˜Ÿç©ºèƒŒæ™¯ */}
          <Stars radius={100} depth={50} count={5000} factor={4} saturation={0} fade speed={1} />
          
          {/* å…‰ç…§ */}
          <ambientLight intensity={0.4} />
          <directionalLight position={[10, 20, 10]} intensity={1} castShadow />
          
          {/* å››åˆé™¢åœºæ™¯ */}
          <ChineseCourtyard />
          
          {/* å››é˜¶æ®µéƒ¨é—¨æˆ¿é—´ */}
          <DepartmentRooms onDepartmentClick={handleDepartmentClick} />
          
          {/* åŠå…¬å®¤è£…é¥° */}
          <OfficeDecorations />
          
          {/* 8ä¸ªAI Agent - ä½¿ç”¨ç±»çœŸäººå½¢è±¡ */}
          {(Object.keys(AGENTS_DATA) as AgentRole[]).map((role) => (
            <RealisticAgent
              key={role}
              role={role}
              position={AGENT_POSITIONS[role]}
              onClick={() => handleAgentClick(role)}
              isSelected={selectedRole === role}
            />
          ))}
          
          {/* åä½œè¿çº¿ */}
          <CollaborationLines />
          
          {/* åä½œä¸­å¿ƒ */}
          <CollaborationHub />
          
          {/* æ•°æ®çœ‹æ¿ */}
          <Dashboards />
          
          {/* éƒ¨é—¨ä»»åŠ¡çœ‹æ¿ - æš‚æ—¶ç¦ç”¨æµ‹è¯• */}
          {/* <DepartmentTaskBoards /> */}
          
          {/* èŠå¤©ç³»ç»Ÿ */}
          <AgentChatSystem />
        </Canvas>
      )}
      
      {/* UIç•Œé¢ */}
      <InfoPanel />
      
      <ConnectionIndicator />
      
      <ControlPanel 
        selectedRole={selectedRole}
        onWeatherChange={handleWeatherChange}
      />
      
      {/* å³ä¾§åŠŸèƒ½èœå• */}
      <RightSideMenu
        onViewModeChange={handleViewModeChange}
        onEnterMeetingRoom={handleEnterMeetingRoom}
        viewMode={viewMode}
        currentMeetingRoom={currentMeetingRoom}
      />
      
      {/* è§’è‰²è¯¦æƒ…å¼¹çª— */}
      {selectedRole && (
        <AgentModal 
          role={selectedRole} 
          onClose={handleCloseModal}
          onlineAgents={onlineAgents}
        />
      )}
      
      {/* éƒ¨é—¨ä¿¡æ¯å¼¹çª— */}
      {selectedDept && (
        <DepartmentModal 
          deptKey={selectedDept}
          onClose={handleCloseDeptModal}
        />
      )}
      
      {/* äº¤äº’åé¦ˆ */}
      <InteractionFeedback />
    </div>
  )
}

export default App