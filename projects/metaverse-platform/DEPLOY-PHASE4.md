# æ•°å­—äººå…ƒå®‡å®™å¹³å° Phase 4 éƒ¨ç½²æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†æ•°å­—äººå…ƒå®‡å®™å¹³å° Phase 4 çš„éƒ¨ç½²æµç¨‹ï¼ŒåŒ…æ‹¬åç«¯APIæœåŠ¡ã€å‰ç«¯3Då¯è§†åŒ–ç•Œé¢çš„éƒ¨ç½²æ­¥éª¤å’Œé…ç½®è¯´æ˜ã€‚

**ç‰ˆæœ¬**: 4.0.0  
**æ›´æ–°æ—¥æœŸ**: 2026-02-14  
**ä¸»è¦åŠŸèƒ½**:
- 3Dåœºæ™¯å®æ—¶æ•°æ®åŒæ­¥
- ä»»åŠ¡æµå¯è§†åŒ–
- åä½œå…³ç³»ç½‘ç»œ
- ç®¡ç†ä¸­æ¢

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯ (React + Three.js)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   3Dåœºæ™¯     â”‚  â”‚  ä»»åŠ¡æµå¯è§†åŒ– â”‚  â”‚  åä½œç½‘ç»œ    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                         â†‘ WebSocket                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         â†“                                   â”‚
â”‚              åç«¯ API (Node.js + Express)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Socket.IO (å®æ—¶é€šä¿¡)                      â”‚   â”‚
â”‚  â”‚  â€¢ 3Dåœºæ™¯æˆ¿é—´ (3d:scene:{orgId})                   â”‚   â”‚
â”‚  â”‚  â€¢ ä»»åŠ¡æµæˆ¿é—´ (3d:tasks:{orgId})                   â”‚   â”‚
â”‚  â”‚  â€¢ åä½œç½‘ç»œæˆ¿é—´ (3d:network:{orgId})               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           REST API (Phase 4 æ–°ç«¯ç‚¹)                 â”‚   â”‚
â”‚  â”‚  â€¢ POST /api/metaverse/3d/agents/status/batch      â”‚   â”‚
â”‚  â”‚  â€¢ GET  /api/metaverse/3d/tasks/flow/stream        â”‚   â”‚
â”‚  â”‚  â€¢ GET  /api/metaverse/3d/collaboration/network/v2 â”‚   â”‚
â”‚  â”‚  â€¢ GET  /api/metaverse/3d/scene/config             â”‚   â”‚
â”‚  â”‚  â€¢ GET  /api/metaverse/3d/management-hub           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â†“                                  â”‚
â”‚                    SQLite (Prisma)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ ä¾èµ–æ¸…å•

### åç«¯ä¾èµ–
```json
{
  "express": "^4.18.2",
  "socket.io": "^4.7.2",
  "prisma": "^5.0.0",
  "@prisma/client": "^5.0.0",
  "cors": "^2.8.5",
  "helmet": "^7.0.0",
  "dotenv": "^16.3.1"
}
```

### å‰ç«¯ä¾èµ–
```json
{
  "react": "^18.2.0",
  "three": "^0.155.0",
  "@react-three/fiber": "^8.13.6",
  "@react-three/drei": "^9.80.1",
  "socket.io-client": "^4.7.2"
}
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. åç«¯éƒ¨ç½²

#### 1.1 ç¯å¢ƒå‡†å¤‡

```bash
# è¿›å…¥åç«¯ç›®å½•
cd ~/.openclaw/workspace/projects/metaverse-platform/backend-v2

# å®‰è£…ä¾èµ–
npm install

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
```

#### 1.2 ç¯å¢ƒå˜é‡é…ç½® (.env)

```env
# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=production

# æ•°æ®åº“
DATABASE_URL="file:./dev.db"

# CORSé…ç½®
CORS_ORIGIN="http://localhost:5173"

# WebSocketé…ç½®
WS_TRANSPORTS=["websocket","polling"]
```

#### 1.3 æ•°æ®åº“åˆå§‹åŒ–

```bash
# ç”ŸæˆPrismaå®¢æˆ·ç«¯
npx prisma generate

# è¿è¡Œæ•°æ®åº“è¿ç§»
npx prisma migrate deploy

# (å¯é€‰) ç§å­æ•°æ®
npx prisma db seed
```

#### 1.4 ç¼–è¯‘å’Œå¯åŠ¨

```bash
# TypeScriptç¼–è¯‘
npm run build

# å¯åŠ¨æœåŠ¡
npm start

# æˆ–ä½¿ç”¨PM2è¿›è¡Œè¿›ç¨‹ç®¡ç†
pm2 start dist/index.js --name metaverse-backend
```

#### 1.5 å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:3000/health

# é¢„æœŸå“åº”
{
  "status": "ok",
  "version": "4.0.0",
  "phase": "4",
  "features": ["3d_agent_batch_status", "3d_task_flow_stream", ...]
}
```

---

### 2. å‰ç«¯éƒ¨ç½²

#### 2.1 ç¯å¢ƒå‡†å¤‡

```bash
# è¿›å…¥å‰ç«¯ç›®å½•
cd ~/.openclaw/workspace/projects/metaverse-office/src/frontend

# å®‰è£…ä¾èµ–
npm install
```

#### 2.2 ç¯å¢ƒå˜é‡é…ç½® (.env)

```env
# APIé…ç½®
VITE_API_BASE_URL=http://localhost:3000
VITE_WS_URL=http://localhost:3000

# é»˜è®¤ç»„ç»‡ID
VITE_DEFAULT_ORGANIZATION_ID=org_default
```

#### 2.3 å¼€å‘å’Œç”Ÿäº§æ„å»º

```bash
# å¼€å‘æ¨¡å¼
npm run dev

# ç”Ÿäº§æ„å»º
npm run build

# é¢„è§ˆç”Ÿäº§æ„å»º
npm run preview
```

#### 2.4 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

```bash
# æ„å»ºé™æ€æ–‡ä»¶
npm run build

# å°†distç›®å½•éƒ¨ç½²åˆ°WebæœåŠ¡å™¨
# Nginxé…ç½®ç¤ºä¾‹:
server {
    listen 80;
    server_name metaverse.example.com;
    root /var/www/metaverse-office/dist;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### åç«¯é…ç½®

#### Socket.IO æˆ¿é—´é…ç½®

| æˆ¿é—´åç§° | ç”¨é€” | äº‹ä»¶ |
|---------|------|------|
| `3d:scene:{orgId}` | 3Dåœºæ™¯åŒæ­¥ | `3d:agent:status`, `3d:agent:position:update` |
| `3d:tasks:{orgId}` | ä»»åŠ¡æµæ›´æ–° | `3d:task:flow:update` |
| `3d:network:{orgId}` | åä½œç½‘ç»œ | `3d:network:update` |
| `org:{orgId}` | ç»„ç»‡å¹¿æ’­ | `system:notification` |

#### API é€Ÿç‡é™åˆ¶

```typescript
// å»ºè®®é…ç½®
const rateLimit = {
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: 100 // æ¯ä¸ªIPæœ€å¤š100ä¸ªè¯·æ±‚
}
```

### å‰ç«¯é…ç½®

#### WebSocket é‡è¿ç­–ç•¥

```typescript
{
  reconnection: true,
  reconnectionAttempts: 5,
  reconnectionDelay: 1000,
  reconnectionDelayMax: 5000
}
```

#### 3Dåœºæ™¯æ€§èƒ½ä¼˜åŒ–

```typescript
// åŒæ—¶æ˜¾ç¤ºçš„æœ€å¤§Agentæ•°
const MAX_VISIBLE_AGENTS = 20

// è§†è·å‰”é™¤è·ç¦»
const CULLING_DISTANCE = 50

// LODï¼ˆç»†èŠ‚å±‚æ¬¡ï¼‰è·ç¦»
const LOD_DISTANCES = [10, 25, 50]
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. WebSocketè¿æ¥å¤±è´¥

**ç—‡çŠ¶**: å‰ç«¯æ˜¾ç¤º"ç¦»çº¿æ¨¡å¼"

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
curl http://localhost:3000/health

# æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
sudo ufw allow 3000

# æ£€æŸ¥CORSé…ç½®
# ç¡®ä¿CORS_ORIGINåŒ…å«å‰ç«¯åŸŸå
```

#### 2. 3Dåœºæ™¯åŠ è½½ç¼“æ…¢

**ç—‡çŠ¶**: è§’è‰²æ¨¡å‹åŠ è½½æ…¢ã€å¡é¡¿

**è§£å†³æ–¹æ¡ˆ**:
- å¯ç”¨æ¨¡å‹å‹ç¼© (Draco)
- ä½¿ç”¨çº¹ç†å›¾é›†
- å®æ–½è§†è·å‰”é™¤
- é™ä½åŒæ—¶æ¸²æŸ“çš„Agentæ•°é‡

#### 3. æ•°æ®åº“è¿æ¥é”™è¯¯

**ç—‡çŠ¶**: APIè¿”å›500é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™
ls -la prisma/dev.db

# é‡æ–°ç”ŸæˆPrismaå®¢æˆ·ç«¯
npx prisma generate

# é‡ç½®æ•°æ®åº“ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
npx prisma migrate reset
```

#### 4. å†…å­˜æ³„æ¼

**ç—‡çŠ¶**: æœåŠ¡è¿è¡Œä¸€æ®µæ—¶é—´åå†…å­˜æŒç»­å¢é•¿

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥Socket.IOè¿æ¥æ˜¯å¦æ­£ç¡®æ¸…ç†
- é™åˆ¶å†å²æ•°æ®ç¼“å­˜å¤§å°
- å¯ç”¨Node.jsåƒåœ¾å›æ”¶æ—¥å¿—
```bash
node --expose-gc --trace-gc dist/index.js
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—é…ç½®

```typescript
// Winstonæ—¥å¿—é…ç½®
const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
  ],
})
```

### å…³é”®æŒ‡æ ‡ç›‘æ§

| æŒ‡æ ‡ | å‘Šè­¦é˜ˆå€¼ | è¯´æ˜ |
|-----|---------|------|
| WebSocketè¿æ¥æ•° | >1000 | å¹¶å‘è¿æ¥æ•° |
| APIå“åº”æ—¶é—´ | >500ms | P95å“åº”æ—¶é—´ |
| å†…å­˜ä½¿ç”¨ | >80% | æœåŠ¡å™¨å†…å­˜ |
| CPUä½¿ç”¨ | >70% | æœåŠ¡å™¨CPU |
| æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ | >100ms | æ…¢æŸ¥è¯¢ |

---

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. ç½‘ç»œå®‰å…¨

- ä½¿ç”¨HTTPS/WSS
- é…ç½®é˜²ç«å¢™è§„åˆ™
- å¯ç”¨CORSç™½åå•
- å®æ–½APIé€Ÿç‡é™åˆ¶

### 2. æ•°æ®å®‰å…¨

- æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- å®šæœŸå¤‡ä»½æ•°æ®åº“
- å®æ–½æ•°æ®æ¸…ç†ç­–ç•¥

### 3. è®¤è¯æˆæƒ

```typescript
// å»ºè®®é›†æˆJWTè®¤è¯
app.use('/api', jwtMiddleware)
app.use('/api/metaverse/3d', requireAuth)
```

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### Phase 4 (v4.0.0)

**æ–°å¢åŠŸèƒ½**:
- 3D Agentæ‰¹é‡çŠ¶æ€æŸ¥è¯¢API
- ä»»åŠ¡æµå®æ—¶æ•°æ®æµ
- åä½œå…³ç³»ç½‘ç»œè®¡ç®—V2
- 3Dåœºæ™¯é…ç½®ç®¡ç†
- ç®¡ç†ä¸­æ¢æ•°æ®API
- WebSocket 3Dæˆ¿é—´æ”¯æŒ
- å®æ—¶AgentçŠ¶æ€åŒæ­¥

**ä¼˜åŒ–**:
- å‰ç«¯åŠ¨æ€æ•°æ®åŠ è½½
- AgentçŠ¶æ€ç¯å®æ—¶åŒæ­¥
- ä»»åŠ¡ç®¡é“åŠ¨ç”»
- æ€§èƒ½ä¼˜åŒ–

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æäº¤Issueã€‚

**ä»“åº“åœ°å€**:
- åç«¯: `~/.openclaw/workspace/projects/metaverse-platform/backend-v2`
- å‰ç«¯: `~/.openclaw/workspace/projects/metaverse-office`

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚éœ€è¦å›æ»šåˆ°Phase 3:

```bash
# åç«¯å›æ»š
cd ~/.openclaw/workspace/projects/metaverse-platform/backend-v2
git checkout phase-3
npm run build
pm2 restart metaverse-backend

# å‰ç«¯å›æ»š
cd ~/.openclaw/workspace/projects/metaverse-office/src/frontend
git checkout phase-3
npm run build
```

---

**æ–‡æ¡£ç»“æŸ**
