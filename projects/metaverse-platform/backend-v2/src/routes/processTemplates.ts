import { Router, Request, Response } from 'express';
import { prisma } from '../lib/prisma';
import { asyncHandler, AppError } from '../utils/error';
import { ProcessTemplateCreateInput, ProcessTemplateUpdateInput } from '../types/index';
const router = Router();
router.get('/', asyncHandler(async (req: Request, res: Response) => { const { businessId, status } = req.query; const templates = await prisma.processTemplate.findMany({ where: { ...(businessId && { businessId: businessId as string }), ...(status && { status: status as string }) }, include: { business: { select: { id: true, name: true } }, _count: { select: { processInstances: true } } }, orderBy: { createdAt: 'desc' } }); res.json({ success: true, data: templates }); }));
router.get('/:id', asyncHandler(async (req: Request, res: Response) => { const template = await prisma.processTemplate.findUnique({ where: { id: req.params.id as string }, include: { business: { select: { id: true, name: true } }, processInstances: { select: { id: true, status: true, createdAt: true }, take: 10, orderBy: { createdAt: 'desc' } } } }); if (!template) throw new AppError('Template not found', 404); res.json({ success: true, data: template }); }));
router.post('/', asyncHandler(async (req: Request, res: Response) => { const data: ProcessTemplateCreateInput = req.body; if (!data.name || !data.businessId) throw new AppError('Name and businessId required', 400); const template = await prisma.processTemplate.create({ data: { name: data.name, description: data.description, definition: JSON.stringify(data.definition), businessId: data.businessId }, include: { business: { select: { id: true, name: true } } } }); res.status(201).json({ success: true, data: template }); }));
router.put('/:id', asyncHandler(async (req: Request, res: Response) => { const data: ProcessTemplateUpdateInput = req.body; const existing = await prisma.processTemplate.findUnique({ where: { id: req.params.id as string } }); if (!existing) throw new AppError('Template not found', 404); if (existing.status === 'published' && data.definition) throw new AppError('Cannot modify published template', 400); const template = await prisma.processTemplate.update({ where: { id: req.params.id as string }, data: { ...(data.name && { name: data.name }), ...(data.description && { description: data.description }), ...(data.definition && { definition: JSON.stringify(data.definition) }), ...(data.status && { status: data.status }) }, include: { business: { select: { id: true, name: true } } } }); res.json({ success: true, data: template }); }));
router.patch('/:id/publish', asyncHandler(async (req: Request, res: Response) => { const template = await prisma.processTemplate.findUnique({ where: { id: req.params.id as string } }); if (!template) throw new AppError('Template not found', 404); if (template.status === 'published') throw new AppError('Already published', 400); const updated = await prisma.processTemplate.update({ where: { id: req.params.id as string }, data: { status: 'published' }, include: { business: { select: { id: true, name: true } } } }); res.json({ success: true, data: updated }); }));
router.delete('/:id', asyncHandler(async (req: Request, res: Response) => { const existing = await prisma.processTemplate.findUnique({ where: { id: req.params.id as string }, include: { _count: { select: { processInstances: true } } } }); if (!existing) throw new AppError('Template not found', 404); if (existing._count.processInstances > 0) throw new AppError('Has instances', 400); await prisma.processTemplate.delete({ where: { id: req.params.id as string } }); res.json({ success: true, message: 'Template deleted' }); }));
export default router;
